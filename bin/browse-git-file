#!/bin/bash

set -e

git_origin="$(git remote get-url origin)"


################################################################################
### Helpers
################################################################################

function open_remote_url() {
    local remote_url="$1"

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        xdg-open "$remote_url"

        ## hack for `xdg-open` working with async-shell-command
        sleep 1
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        open "$remote_url"
    else
        open "Don't know how to open $remote_url on OS: $OSTYPE"
        exit 1
    fi
}

function handle_github_file() {
    local git_head="$1"
    local git_full_name="$2"
    local remote_url="$(echo $git_origin | sed 's/git@\(.*\):\(.*\).git/https:\/\/\1\/\2/')/$(echo $git_origin | sed -n 's/.*github.*/blob/p')/$git_head/$git_full_name"
    open_remote_url $remote_url
}

function handle_bitbucket_file() {
    local git_head="$1"
    local git_full_name="$2"
    local remote_url="$(echo $git_origin | sed 's|ssh://||' | sed 's|git@\(.*\)\/\(.*\)\/\(.*\).git|https://\1/projects/\2/repos/\3/browse|')/$git_full_name?at=$git_head"
    open_remote_url $remote_url
}

function handle_github_commit() {
    local commit_hash="$1"
    local base_url="$(echo "$git_origin" | sed 's/git@\(.*\):\(.*\).git/https:\/\/\1\/\2/')"
    open_remote_url "$base_url/commit/$commit_hash"
}

function handle_bitbucket_commit() {
    local commit_hash="$1"
    local base_url="$(echo "$git_origin" \
        | sed 's|ssh://||' \
        | sed 's|git@\(.*\)\/\(.*\)\/\(.*\).git|https://\1/projects/\2/repos/\3|')"
    open_remote_url "$base_url/commits/$commit_hash"
}


################################################################################
### Main logic
################################################################################

if [[ "$1" == "--hash" ]]; then
    if [[ -z "$2" ]]; then
        echo "Usage: browse-git-file --hash <commit-hash>"
        exit 1
    fi
    commit_hash="$2"
    if [[ "$git_origin" == *"github"* ]]; then
        handle_github_commit "$commit_hash"
    elif [[ "$git_origin" == *"bitbucket"* ]]; then
        handle_bitbucket_commit "$commit_hash"
    else
        echo "Unknown repo. Only GitHub and Bitbucket are supported."
        exit 1
    fi
else
    git_file="$1"

    if [[ -z "$git_file" ]]; then
        echo "Usage:"
        echo "  browse-git-file path/to/file"
        echo "  browse-git-file --hash <commit-hash>"
        exit 1
    fi

    git_head="$(git rev-parse HEAD)"
    git_full_name="$(git ls-files --full-name $git_file)"

    if [[ "$git_origin" == *"github"* ]]; then
        handle_github_file "$git_head" "$git_full_name"
    elif [[ "$git_origin" == *"bitbucket"* ]]; then
        handle_bitbucket_file "$git_head" "$git_full_name"
    else
        echo "Unknown repo. Only GitHub and Bitbucket are supported."
        exit 1
    fi
fi
